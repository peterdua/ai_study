# AI 教学平台 - 技术架构方案

## 一、整体架构设计

### 1.1 系统架构图
```
┌─────────────────────────────────────────────────────────┐
│                       前端层 (Frontend)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  课程播放器  │  │  数字人组件  │  │  控制面板    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│         React 18 + TypeScript + Ant Design              │
└─────────────────────────────────────────────────────────┘
                            ↕ REST API
┌─────────────────────────────────────────────────────────┐
│                     后端层 (Backend)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  课程管理    │  │  进度追踪    │  │  用户认证    │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│                FastAPI + SQLAlchemy                     │
└─────────────────────────────────────────────────────────┘
                            ↕ API 调用
┌─────────────────────────────────────────────────────────┐
│                    AI 服务层 (AI Services)               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  TTS 引擎    │  │  数字人生成  │  │  LLM 答疑    │  │
│  │  (OpenAI)    │  │  (D-ID)      │  │  (GPT-4)     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↕ 数据存储
┌─────────────────────────────────────────────────────────┐
│                   数据存储层 (Storage)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ PostgreSQL   │  │    Redis     │  │   OSS/CDN    │  │
│  │ (结构化数据) │  │   (缓存)     │  │  (媒体文件)  │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 二、技术栈选型

### 2.1 前端技术栈
| 技术 | 选型 | 说明 |
|------|------|------|
| 框架 | **React 18 + TypeScript** | 类型安全、生态成熟、组件化开发 |
| 状态管理 | **Zustand** | 轻量级、API 简洁、适合中小型项目 |
| UI 组件库 | **Ant Design** | 企业级组件库、开箱即用 |
| PPT 展示 | **图片序列 + Swiper** | 灵活可控、加载快 |
| 视频播放 | **Video.js** | 功能丰富、支持自定义控制器 |
| 音频处理 | **Howler.js** | 精确控制、跨浏览器兼容 |
| HTTP 客户端 | **Axios** | 拦截器、请求取消、TypeScript 支持 |
| 构建工具 | **Vite** | 快速冷启动、HMR、优化打包 |

### 2.2 后端技术栈
| 技术 | 选型 | 说明 |
|------|------|------|
| Web 框架 | **FastAPI** | 高性能、自动 API 文档、类型提示 |
| ORM | **SQLAlchemy 2.0** | 功能强大、支持异步 |
| 数据库 | **PostgreSQL 15** | 稳定可靠、JSON 支持、全文搜索 |
| 缓存 | **Redis 7** | 高性能、数据结构丰富 |
| 任务队列 | **Celery + Redis** | 异步任务处理、课程预处理 |
| 认证 | **JWT + OAuth2** | 无状态认证、安全性高 |
| 文件存储 | **阿里云 OSS** | CDN 加速、成本低 |

### 2.3 AI 服务选型
| 服务 | 推荐方案 | 备选方案 | 成本 |
|------|---------|---------|------|
| TTS 语音合成 | **OpenAI TTS-1** | Azure TTS | $15/1M 字符 |
| 数字人生成 | **D-ID API** | HeyGen / 自研 Wav2Lip | $0.08/视频 |
| LLM 答疑 | **GPT-4-turbo** | Claude 3.5 Sonnet | $10/1M tokens |
| 向量检索 | **Pinecone** | Milvus (自部署) | $70/月起 |
| Embeddings | **text-embedding-3-large** | - | $0.13/1M tokens |

## 三、核心数据模型设计

### 3.1 课程数据结构
```json
{
  "course_id": "course_001",
  "course_name": "产品介绍培训课程",
  "description": "全面了解公司产品功能与特性",
  "total_pages": 15,
  "estimated_duration": 45,
  "digital_human": {
    "avatar_id": "female_teacher_01",
    "avatar_url": "https://cdn.example.com/avatars/teacher_01.jpg",
    "voice_id": "zh-CN-XiaoxiaoNeural"
  },
  "pages": [
    {
      "page_id": 1,
      "ppt_image_url": "https://cdn.example.com/course_001/page_1.png",
      "script": "欢迎来到产品介绍课程，今天我们将全面了解公司的核心产品...",
      "digital_human_video_url": "https://cdn.example.com/course_001/dh_page_1.mp4",
      "audio_url": "https://cdn.example.com/course_001/audio_page_1.mp3",
      "duration": 45.5,
      "has_question": true,
      "question": {
        "question_id": "q1",
        "type": "single_choice",
        "question_text": "我们的产品主要解决什么问题？",
        "options": [
          {"id": "A", "text": "提升工作效率"},
          {"id": "B", "text": "降低运营成本"},
          {"id": "C", "text": "以上都是"}
        ],
        "correct_answer": "C",
        "explanation": "我们的产品通过自动化流程，既提升了工作效率，又降低了人工成本。"
      }
    }
    // ... 更多页面
  ]
}
```

### 3.2 数据库表设计
```sql
-- 课程表
CREATE TABLE courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    total_pages INTEGER,
    estimated_duration INTEGER,
    avatar_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 课程页面表
CREATE TABLE course_pages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
    page_number INTEGER NOT NULL,
    ppt_image_url TEXT NOT NULL,
    script TEXT NOT NULL,
    video_url TEXT,
    audio_url TEXT,
    duration FLOAT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(course_id, page_number)
);

-- 问题表
CREATE TABLE questions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    page_id UUID REFERENCES course_pages(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL, -- single_choice, multiple_choice, text
    question_text TEXT NOT NULL,
    options JSONB,
    correct_answer VARCHAR(255),
    explanation TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(100) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(50) DEFAULT 'student', -- student, teacher, admin
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 学习进度表
CREATE TABLE learning_progress (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    course_id UUID REFERENCES courses(id) ON DELETE CASCADE,
    page_id UUID REFERENCES course_pages(id) ON DELETE CASCADE,
    completed BOOLEAN DEFAULT FALSE,
    time_spent INTEGER, -- 秒
    last_position FLOAT DEFAULT 0, -- 音频播放位置
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, page_id)
);

-- 答题记录表
CREATE TABLE answer_records (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    question_id UUID REFERENCES questions(id) ON DELETE CASCADE,
    user_answer VARCHAR(255),
    is_correct BOOLEAN,
    answered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_learning_progress_user_course ON learning_progress(user_id, course_id);
CREATE INDEX idx_answer_records_user ON answer_records(user_id);
CREATE INDEX idx_course_pages_course ON course_pages(course_id, page_number);
```

## 四、部署架构

### 4.1 生产环境部署
```yaml
# docker-compose.yml
version: '3.8'

services:
  # 前端 (Nginx + React 静态文件)
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend/dist:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - backend

  # 后端 API
  backend:
    build: ./backend
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/aiplatform
      - REDIS_URL=redis://redis:6379/0
      - OSS_ENDPOINT=oss-cn-hangzhou.aliyuncs.com
    depends_on:
      - postgres
      - redis
    command: uvicorn main:app --host 0.0.0.0 --port 8000

  # PostgreSQL 数据库
  postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=aiplatform
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis 缓存
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  # Celery 任务队列
  celery_worker:
    build: ./backend
    command: celery -A tasks worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://user:pass@postgres:5432/aiplatform
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - postgres
      - redis

volumes:
  postgres_data:
  redis_data:
```

### 4.2 云服务配置
- **服务器**: 阿里云 ECS (4核8G) × 1 台
- **数据库**: RDS PostgreSQL (2核4G)
- **缓存**: Redis 企业版 (1G)
- **存储**: OSS 标准存储 + CDN 加速
- **域名**: 阿里云域名 + SSL 证书

### 4.3 监控与日志
- **应用监控**: Sentry (错误追踪)
- **性能监控**: New Relic / 阿里云 ARMS
- **日志收集**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **告警通知**: 钉钉机器人 / 邮件

## 五、安全性设计

### 5.1 认证与授权
```python
# JWT 认证示例
from fastapi import Depends, HTTPException, status
from fastapi.security import OAuth2PasswordBearer
from jose import JWTError, jwt

oauth2_scheme = OAuth2PasswordBearer(tokenUrl="token")

async def get_current_user(token: str = Depends(oauth2_scheme)):
    credentials_exception = HTTPException(
        status_code=status.HTTP_401_UNAUTHORIZED,
        detail="Could not validate credentials"
    )
    try:
        payload = jwt.decode(token, SECRET_KEY, algorithms=[ALGORITHM])
        user_id: str = payload.get("sub")
        if user_id is None:
            raise credentials_exception
    except JWTError:
        raise credentials_exception
    
    user = get_user_by_id(user_id)
    if user is None:
        raise credentials_exception
    return user
```

### 5.2 数据安全
- **密码加密**: bcrypt
- **API 密钥管理**: 环境变量 + AWS Secrets Manager
- **HTTPS**: Let's Encrypt SSL 证书
- **CORS**: 严格的跨域策略
- **SQL 注入防护**: ORM 参数化查询
- **XSS 防护**: 前端输入过滤 + CSP

### 5.3 访问控制
- **角色权限**: RBAC (Role-Based Access Control)
- **API 限流**: Redis + FastAPI-Limiter
- **防爬虫**: User-Agent 检测 + Token 验证
