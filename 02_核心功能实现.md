# AI 教学平台 - 核心功能实现详解

## 一、课程播放器架构

### 1.1 播放流程图
```
[用户进入课程] 
    ↓
[加载课程数据] → API: GET /api/courses/{id}
    ↓
[展示第1页PPT + 数字人准备]
    ↓
[用户点击播放]
    ↓
[同步播放数字人视频 + TTS音频] ← 使用Video.js + Howler.js
    ↓
[实时同步检查] (每100ms校准视频/音频时间差)
    ↓
[监听音频播放完成]
    ↓
[是否有问题?] ─否→ [自动翻页] → 回到播放流程
    ↓ 是
[暂停播放]
    ↓
[弹出问答Modal]
    ↓
[用户选择答案并提交]
    ↓
[显示正确答案+解析]
    ↓
[上报答题记录] → API: POST /api/answers
    ↓
[用户点击"继续"]
    ↓
[返回播放流程]
```

### 1.2 前端状态管理（Zustand）

```typescript
// src/store/playerStore.ts
interface PlayerState {
  courseData: CourseData | null;
  currentPage: number;
  playStatus: 'idle' | 'playing' | 'paused' | 'questioning';
  playbackSpeed: 0.5 | 1.0 | 1.5 | 2.0;
  audioProgress: number;
  
  // Actions
  loadCourse: (data: CourseData) => void;
  play: () => void;
  pause: () => void;
  nextPage: () => void;
  setSpeed: (speed: number) => void;
}
```

### 1.3 核心组件结构
```
CoursePlayer/
├── index.tsx              # 主播放器容器
├── PPTDisplay.tsx         # PPT展示组件
├── DigitalHuman.tsx       # 数字人视频组件  
├── PlayerControls.tsx     # 播放控制面板
├── QuestionModal.tsx      # 问答弹窗
└── ProgressTracker.tsx    # 进度追踪组件
```

## 二、数字人 + TTS 实现方案

### 2.1 方案对比

| 方案 | 优点 | 缺点 | 成本 | 开发周期 |
|------|------|------|------|---------|
| **D-ID API** | 质量高、开发快、省资源 | 依赖外部、成本较高 | $0.08/视频 | 1周 |
| **HeyGen API** | 效果自然、支持中文 | 价格较高 | $0.12/视频 | 1周 |
| **自研(Wav2Lip)** | 成本低、可控 | 需GPU、开发慢 | 服务器成本 | 4-6周 |

**推荐**: 先用 D-ID 快速上线，后期优化可切换自研

### 2.2 D-ID 集成示例

```python
# backend/services/digital_human_service.py
class DigitalHumanService:
    async def generate_video(self, script: str, audio_url: str) -> str:
        """生成数字人视频"""
        # 1. 创建任务
        response = requests.post(
            "https://api.d-id.com/talks",
            headers={"Authorization": f"Bearer {API_KEY}"},
            json={
                "source_url": "https://cdn.example.com/avatar.jpg",
                "script": {
                    "type": "audio",
                    "audio_url": audio_url
                },
                "config": {"fluent": True}
            }
        )
        talk_id = response.json()["id"]
        
        # 2. 轮询状态
        while True:
            status = requests.get(f"https://api.d-id.com/talks/{talk_id}")
            if status.json()["status"] == "done":
                return status.json()["result_url"]
            await asyncio.sleep(5)
```

### 2.3 前端同步播放

```typescript
// 关键：确保视频和音频同步
useEffect(() => {
  const syncInterval = setInterval(() => {
    if (videoRef.current && audioRef.current) {
      const diff = Math.abs(
        videoRef.current.currentTime - audioRef.current.currentTime
      );
      // 如果差距超过300ms，则强制同步
      if (diff > 0.3) {
        videoRef.current.currentTime = audioRef.current.currentTime;
      }
    }
  }, 100);
  
  return () => clearInterval(syncInterval);
}, []);
```

## 三、课程数据结构

### 3.1 完整课程JSON
```json
{
  "course_id": "course_001",
  "course_name": "产品介绍培训",
  "total_pages": 15,
  "pages": [
    {
      "page_id": 1,
      "ppt_image_url": "https://cdn.xxx.com/course_001/page_1.png",
      "script": "欢迎来到产品介绍课程...",
      "digital_human_video_url": "https://cdn.xxx.com/course_001/dh_1.mp4",
      "audio_url": "https://cdn.xxx.com/course_001/audio_1.mp3",
      "duration": 45.5,
      "has_question": true,
      "question": {
        "question_id": "q1",
        "question_text": "我们的产品主要解决什么问题？",
        "options": [
          {"id": "A", "text": "效率问题"},
          {"id": "B", "text": "成本问题"},
          {"id": "C", "text": "以上都是"}
        ],
        "correct_answer": "C",
        "explanation": "产品同时解决效率和成本问题..."
      }
    }
  ]
}
```

## 四、后端API设计

### 4.1 核心接口

```python
# main.py
@app.get("/api/v1/courses/{course_id}")
async def get_course(course_id: str):
    """获取完整课程数据"""
    return course_data

@app.post("/api/v1/progress")
async def update_progress(progress: ProgressUpdate):
    """更新学习进度"""
    # 记录: 页面ID、停留时长、是否完成
    pass

@app.post("/api/v1/answers")
async def submit_answer(answer: AnswerSubmit):
    """提交答题记录"""
    # 记录: 问题ID、用户答案、是否正确
    pass
```

## 五、课程预处理流程

### 5.1 输入材料
```
course_materials/
├── slides.pptx          # PPT文件
├── scripts.json         # 讲解文稿
└── questions.json       # 问题配置
```

### 5.2 处理步骤
```python
# 课程预处理脚本
async def preprocess_course(course_config):
    # Step 1: PPT → 图片序列
    ppt_images = convert_ppt_to_images("slides.pptx")
    
    # Step 2: 文稿 → TTS音频
    audio_files = []
    for script in scripts:
        audio = await openai_tts(script, voice="alloy")
        audio_files.append(audio)
    
    # Step 3: 音频 + 头像 → 数字人视频
    video_files = []
    for audio in audio_files:
        video = await did_api.generate(avatar_id, audio)
        video_files.append(video)
    
    # Step 4: 上传到OSS/CDN
    urls = upload_to_oss(ppt_images + audio_files + video_files)
    
    # Step 5: 生成课程JSON并存入数据库
    course_data = build_course_json(urls, questions)
    save_to_db(course_data)
```

## 六、性能优化策略

### 6.1 加载优化
- **预加载**: 提前加载下一页的PPT图片和视频
- **CDN加速**: 所有媒体文件通过阿里云CDN分发
- **视频压缩**: H.264编码，720p分辨率，平衡质量与大小
- **图片格式**: WebP格式（比PNG小70%）

### 6.2 播放流畅度
- **缓冲策略**: 视频预加载5秒缓冲
- **降级方案**: 网络差时自动降低视频清晰度
- **同步机制**: 每100ms检查音视频同步，差距>300ms则校正

### 6.3 前端优化
```typescript
// 预加载下一页资源
useEffect(() => {
  if (currentPage < totalPages - 1) {
    const nextPage = courseData.pages[currentPage + 1];
    
    // 预加载图片
    const img = new Image();
    img.src = nextPage.ppt_image_url;
    
    // 预加载视频
    const link = document.createElement('link');
    link.rel = 'prefetch';
    link.href = nextPage.digital_human_video_url;
    document.head.appendChild(link);
  }
}, [currentPage]);
```

## 七、数据库设计

### 7.1 核心表结构
```sql
-- 课程表
CREATE TABLE courses (
    id UUID PRIMARY KEY,
    name VARCHAR(255),
    total_pages INT,
    created_at TIMESTAMP
);

-- 课程页面表
CREATE TABLE course_pages (
    id UUID PRIMARY KEY,
    course_id UUID REFERENCES courses(id),
    page_number INT,
    ppt_url TEXT,
    video_url TEXT,
    audio_url TEXT,
    duration FLOAT,
    script TEXT
);

-- 问题表
CREATE TABLE questions (
    id UUID PRIMARY KEY,
    page_id UUID REFERENCES course_pages(id),
    question_text TEXT,
    options JSONB,
    correct_answer VARCHAR(10),
    explanation TEXT
);

-- 学习进度表
CREATE TABLE learning_progress (
    user_id UUID,
    page_id UUID,
    completed BOOLEAN,
    time_spent INT,
    last_position FLOAT,
    updated_at TIMESTAMP
);

-- 答题记录表
CREATE TABLE answer_records (
    user_id UUID,
    question_id UUID,
    user_answer VARCHAR(10),
    is_correct BOOLEAN,
    answered_at TIMESTAMP
);
```

## 八、成本估算

### 8.1 单个课程制作成本（15页）
- PPT转图片: 免费（自动化）
- TTS音频: OpenAI $15/1M字符 ≈ ¥5
- 数字人视频: D-ID $0.08 × 15 = $1.2 ≈ ¥9
- **总计**: ≈ ¥15/课程


